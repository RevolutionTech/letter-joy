name: CI
on: push

jobs:
  test:
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@v2
      - run: yarn install

      - run: yarn typecheck
      - run: yarn lint

  deploy:
    runs-on: ubuntu-20.04
    needs: test
    environment: prod
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v2
      - run: npm i -g @railway/cli
      - run: yarn install

      - run: yarn client:build
      - run: yarn server:build
      - run: railway up
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
